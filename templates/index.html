<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
     <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="utf-8">
    <style>
    .bar { fill: steelblue; }

    .my-custom-scrollbar {
            position: relative;
            height: 200px;
            overflow: auto;
            }
    .table-wrapper-scroll-y {
            display: block;
            }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <title>Cisco DNA Spaces Accuracy Test Tool</title>
  </head>
  <body onload="plotDevices()">
    <div class="container-fluid">
        <div class="col">
        <div class="card-group">
            <div class="card">
                <h5 class="card-header">Cisco DNA Spaces Firehose Accuracy Tool</h5>
                    <div class="card-body">
                        <h5 class="card-title">Activate Firehose App to get API Key</h5>
                          <form action="/activate" method=post>
                            <dl>
                                <dt>Firehose Activation Token:</dt>
                                    <dd><input class="form-control" placeholder="App Activation Token"  type=text name=token>
                                    <dd><input class="btn btn-primary" type=submit name="Activate" value="Activate"></dd>
                            </dl>
                          </form>
                    </div>
            </div>
            <div class="card">
                <h5 class="card-header">Summary Statisitics</h5>
                    <div class="card-body">
                    <h5 class="card-title">Calculate location update</h5>
                  <p class="card-text">Provide your MAC address, X and Y coordinates on the map and hit start. The output will include a table of location errors for each
                  new location update from DNA Spaces and the time since the start button his hit. </p>
                    {% if client.tracking %}
                        <form action="/track" method=post>
                            <dl>
                            <dt>Firehose API Key:
                            <dd><input class="form-control" value={{ api_key }} name="api_key" type="text"></dd>
                            <dt>MAC Address:
                            <dd><input class="form-control" value={{ client.mac }} type=text length="17" name=mac_address>
                            <dt>Real X-Coordinate:
                            <dd><input class="form-control" value={{ client.x}}  type=number step="0.01" name=x_coordinates>
                            <dt>Real Y-Coordinate:
                            <dd><input class="form-control" value={{ client.y }}  type=number step="0.01" name=y_coordinates>
                            <dt>Location Id:
                            <dd><input class="form-control" value={{ client.location_id }}  type="text" name=location_id>
                            <dt>Time to test (sec):
                            <dd><input class="form-control" value={{ client.test_time }}  type=number step="0" name=test_time>
                            <dd><input class="btn btn-primary" type=submit name="submit" value="Track">
                            </dl>
                        </form>
                    {% else %}
                        <form action="/track" method=post>
                            <dl>
                            <dt>Firehose API Key:
                            <dd><input class="form-control" value={{ api_key }} name="api_key" type="text"></dd>
                            <dt>MAC Address:
                            <dd><input class="form-control" placeholder="aa:bb:cc:dd:ee:ff:11" type="text"   length="17" name=mac_address>
                            <dt>Real X-Coordinate:
                            <dd><input class="form-control" placeholder="10"  type=number step="0.1" name=x_coordinates>
                            <dt>Real Y-Coordinate:
                            <dd><input class="form-control" placeholder="10"  type=number step="0.1" name=y_coordinates>
                            <dt>Location Id:
                            <dd><input class="form-control" placeholder="Floor"  type="text" name=location_id>
                            <dt>Time to test (sec):
                            <dd><input class="form-control" value="10"  type=number step="0" name=test_time>
                            <dd><input class="btn btn-primary" type=submit name="submit" value="Track">
                            </dl>
                        </form>
                    {% endif %}
                  <p class="card-text"><small id="api_token_help" class="text-muted">Status: Total events received: {{ client.total_events }} Total Interesting Events: {{ client.number_updates }}</small> </p>
                </div>
            </div>
            <div class="card">
            <h5 class="card-header">Summary Statisitics</h5>
                <div class="card-body">
                    {%  if client.number_updates > 0 %}
                    <small>
                        <table class="table table-striped" id="statistics">
                                <thead>
                                    <tr>
                                        <th scope="col">Statistic</th>
                                        <th scope="col">Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                        <tr>
                                            <td>Device Under Test</td>
                                            <td>{{ client.mac }}</td>
                                        </tr>
                                        <tr>
                                            <td>Real Location</td>
                                            <td>({{ client.x }}, {{ client.y }})</td>
                                        </tr>
                                        <tr>
                                            <td>Average Accuracy (mtrs)</td>
                                            <td>{{ stats.average_accuracy }}</td>
                                        </tr>
                                        <tr>
                                            <td>Median Accuracy (mtrs)</td>
                                            <td>{{ stats.median_accuracy }}</td>
                                        </tr>
                                        <tr>
                                            <td>Precision 20 mtrs</td>
                                            <td>{{ stats.precision_20 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Precision 15 mtrs</td>
                                            <td>{{ stats.precision_15 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Precision 10 mtrs</td>
                                            <td>{{ stats.precision_10 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Precision 10 mtrs</td>
                                            <td>{{ stats.precision_10 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Precision 10 mtrs</td>
                                            <td>{{ stats.precision_10 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Precision 5 mtrs</td>
                                            <td>{{ stats.precision_5 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Average Update Interval (sec)</td>
                                            <td>{{ stats.average_latency }}</td>
                                        </tr>
                                        <tr>
                                            <td>Median Update Time (sec)</td>
                                            <td>{{ stats.median_latency }}</td>
                                        </tr>
                                        <tr>
                                            <td>Floor Change events:</td>
                                            <td>{{ stats.floor_change }}</td>
                                        </tr>
                                </tbody>
                            </table>
                    </small>
                    {% endif %}
                    {%  if client.number_updates > 0 %}
                        <button class="btn btn-primary" onclick="exportData()"><i class="fa fa-download"></i> Download</button>
                    {%  else %}
                        <button class="btn btn-primary" onclick="exportData()" disabled><i class="fa fa-download"></i> Download</button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Map</h5>
                    <p class="card-text"><small id="floor_image_status" class="text-muted">Status</small></p>
                    <svg id="image" width="{{ img_width }}" height="{{ img_height }}"></svg>
            </div>
        <div class="card">
        <div class="card-body">
        <h5 class="card-title">Location updates</h5>
          <div class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
            <table class="table table-striped" id="location_updates">
                <thead>
                    <tr>
                        <th scope="col">Timestamp</th>
                        <th scope="col">Predicted X</th>
                        <th scope="col">Predicted Y</th>
                        <th scope="col">Error Distance</th>
                        <th scope="col">Location</th>
                        <th scope="col">Location Id</th>
                        <th scope="col">Confidence Factor (mtrs)</th>
                        <th scope="col">Seconds Elapsed Last Update</th>
                    </tr>
                </thead>
                <tbody>
                    {% for updates in client.location_updates %}
                        <tr>
                            <td>{{updates.timestamp}}</td>
                            <td>{{updates.x}}</td>
                            <td>{{updates.y}}</td>
                            <td>{{updates.error}}</td>
                            <td>{{updates.location}}</td>
                            <td>{{updates.location_id}}</td>
                            <td>{{updates.confidence_factor}}</td>
                            <td>{{updates.seconds}}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
            </table>
          </div>
        </div>
  </div>
</div>
    <!-- Optional JavaScript -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  {% block javascript %}
    <script type="text/javascript">

        function exportData() {
            /* Get the HTML data using Element by Id */
            var table = document.getElementById("location_updates");

            /* Declaring array variable */
            var rows = [];

            //iterate through rows of table
            for (var i = 0, row; row = table.rows[i]; i++) {
                //rows would be accessed using the "row" variable assigned in the for loop
                //Get each cell value/column from the row
                column1 = row.cells[0].innerText;
                column2 = row.cells[1].innerText;
                column3 = row.cells[2].innerText;
                column4 = row.cells[3].innerText;
                column5 = row.cells[4].innerText;
                column6 = row.cells[5].innerText;
                column7 = row.cells[6].innerText;
                column8 = row.cells[7].innerText;

                /* add a new records in the array */
                rows.push(
                    [
                        column1,
                        column2,
                        column3,
                        column4,
                        column5,
                        column6,
                        column7,
                        column8
                    ]
                );

            }
            csvContent = "data:text/csv;charset=utf-8,";
            /* add the column delimiter as comma(,) and each row splitted by new line character (\n) */
            rows.forEach(function (rowArray) {
                row = rowArray.join(",");
                csvContent += row + "\r\n";
            });

            /* create a hidden <a> DOM node and set its download attribute */
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "DNASpaces_Accuracy_Report.csv");
            document.body.appendChild(link);
            /* download the data file named "Stock_Price_Report.csv" */
            link.click();
        }

        function plotDevices(){
            let data = {{ client.location_updates|tojson|safe }}
            const map = "data:image/jpg;base64," + "{{ img_data }}";

            d3.select("#image")
                .append('image')
                .attr("y","0")
                .attr("x","0")
                .attr('xlink:href', map)
                .attr('width', "{{ img_width }}")
                .attr('heigh', "{{ img_height }}")
                .attr("class", "bg-image")

            console.log("plotDevices(): called", data);
            var mapId = "bd1a589f2b97d0b4eb03fcbebb0f4591";

            var margin = {top: 0, right: 0, bottom: 0, left: 0},
                width = {{ img_width }} - margin.left - margin.right;
                height = {{ img_height }} - margin.top - margin.bottom;

            // set the ranges
            var xScale = d3.scaleLinear()
                .domain([0, {{ dim_width }}])
                .range([0, width]);

            var yScale = d3.scaleLinear()
                .domain([{{ dim_length }}, 0])
                .range([height, 0]);
            console.log("plotDevices(): x value 100 scaled to ", xScale(100));
            console.log("plotDevices(): y value 100 scaled to ", yScale(100));

            d3.select("#image")
                .append("g")
                .attr("id", "devices")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("r", 10)
                .attr("cx", function(d){ return xScale(d.x)})
                .attr("cy", function(d){ return yScale(d.y)})
                .style("fill", "lime")
                .style("opacity", 0.5)
                .style("stroke", "darkgreen");

            console.log("Plot real x, y", {{ client.x }}, {{ client.y }});

            d3.select("g")
               .append("circle")
                .attr("id", "real_position")
               .attr("r", 10)
               .attr("cx", xScale({{ client.x }}))
               .attr("cy", yScale({{ client.y }}))
               .style("fill", "red")

            d3.select("#real_position")
                .append("text")
                .attr("dx", xScale({{ client.x }} - 20))
                .text("Real:({{ client.x }}, {{ client.y }})");

        }

  </script>
  {% endblock %}

    </div>
  </body>
</html>